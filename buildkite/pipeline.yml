steps:
  - label: ":hammer: Precompiling Julia {{matrix.version}}"
    commands:
      - "module load julia/{{matrix.version}}"
      - "julia --project=docs/ --color=yes -e 'using Pkg; Pkg.update(); Pkg.develop(PackageSpec(path=pwd())); Pkg.instantiate(); Pkg.precompile()'"
    matrix:
      setup:
        version:
          - "$JULIA_LTS"
          - "$JULIA_LATEST"

  - wait

  - label: ":scroll: Run tests"
    env:
      JULIA_VERSION: "{{matrix.version}}"
    commands:
      - "srun --cpus-per-task=16 --mem=64G --time=1:00:00 --output=.buildkite/log_%j.log --unbuffered .buildkite/jobscript.sh"
    matrix:
      setup:
        version:
          - "$JULIA_LTS"
          - "$JULIA_LATEST"

  - wait

  - label: ":scroll: Build docs"
    commands:
      - "srun --cpus-per-task=16 --mem=64G --time=1:00:00 --output=.buildkite/log_docs_%j.log --unbuffered .buildkite/docs_build.sh"
    env:
      JULIA_PROJECT: "docs/"
      JULIA_VERSION: "$JULIA_LATEST"

  - wait
